---
title: "How we created the sample"
bibliography: MX_WaterSurvey.bib
---

How we obtained the Sample WSS Operators Mexico and what it looks like


```{r SETUP, message=FALSE, warning=FALSE, include=FALSE }
# https://stackoverflow.com/questions/43549930/pdf-figures-not-shown-in-html-files-produced-by-rmarkdown-when-open-with-firefox
# to fix issue of picture not rendering TRY 
# devtools::install_github('yihui/knitr')

knitr::opts_chunk$set(fig.retina = 2,
                      tidy.opts = list(width.cutoff = 120),  # For code
                      options(width = 120) # For output
							 )  

#  The encoding ("ISO-8859-1") is not UTF-8. We will only support UTF-8 in the future. Please re-save your file "sample.Rmd" with the UTF-8 encoding.


# To generate tables using summarytool s own html rendering, the .Rmd document s configuration part (yaml) must point to the package s summarytools.css file.


```

```{r LOADPCK, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(stringr)
library(forcats)
library(scales)
library(patchwork)
library(countrycode)
library(sf)
library(here)
library(kableExtra)
library(summarytools)


```






```{r COPYOUTPimage, message=FALSE, include=FALSE}
# OKKIO, I am in /DataMEX, because it contains a file `.here`
library(here)
here::dr_here(show_reason = T)

from_dir <- here("07_output")
to_dir <- here("MexicoWaterSurvey", "output")

files <- list.files(path = from_dir , full.names = TRUE) #,  pattern = ".png$" )
move <- files[sapply(files, file.size) < 100000000] # < 100 MB or Github will get stuck

# --- SYNTAX
# file.copy(list.of.files, new.folder)

file.copy( move, to = to_dir , overwrite = T )
# if I had listed with full.names = F
# file.copy( file.path(from_dir, move), to = to_dir  )
```

```{r COPYOUTPdata, message=FALSE, include=FALSE}
library(here)
here::dr_here(show_reason = T)

from_dir2 <- here("03_cleandata")
to_dir2 <- here("MexicoWaterSurvey", "data")

files2 <- list.files(path = from_dir2 , full.names = TRUE,  pattern =  "(^oper|^pres).*\\.Rdata$") 
move2 <- files2[sapply(files2, file.size) < 100000000] # < 100 MB or Github will get stuck

# --- SYNTAX
# file.copy(list.of.files, new.folder)
file.copy( move2, to = to_dir2 , overwrite = T )
```



## Sampling design

1. In order to match our sample to official Mexico admin boundaries  (as in Census 2010), I downloaded from INEGI the ID keys and shapefiles (polygons) for  
+ Entidad (32) 
+ Municipios (2546)
+ Localidades URb( 4525 of 192,217 ) MULTiPOLYGON
+ Localidades Rur (187719 of 192,217) points 
+ AGEB urb- 56195 

2. The sample for the survey is mutuated from the sampling design of LAPOP  because the goal is to survey the WSSS providers in the _same_ areas where LAPOP was interviewing households. LAPOP households interviews covered **1,563 IDs** located in **260 clusters**, found in **110 municipios**.[^1] 

[^1]: This information was retrieved from the STATA files with the sample of MX 2016 - (since samples are proportional to the size of the population, larger municipios have more than one PSU (es Tijuana has 61 & 62)). 

LAPOP provided a file with geofences that indicate a circle containing each cluster in 2016 (might be slightly changed in 2018) 
 
3. Based on those, we identified the (expected) clusters for POPA 2018 sample & matched each location with the pertinent WSS Supplier in the area. 
We arrived to a sample of **96 different suppliers**.  

4. This survey encompasses two main goals

	+ I) Survey of WSS suppliers 
	+ II) Survey of small samples of househods served by the above suppliers (also a chance to validate the LAPOP hh survey in the same areas)
	
What follow is a preliminary analysis of the 2 respective samples. 


## (PHASE I) The Water & Sanitation Providers 

Look at THE WATER & SANITATION SERVICE PROVIDERS - SPECIFICALLY IN THE SURVEY AREA

INEGI has identified a total of 2688 _"prestadores"_ in the _"Censo de Captacion, Tratamiento y Suministro de Agua"_ 
conducted in 2014 and published in 2015. Of all of these, some 700 could be rightly defined as _"organismos operadores"_, i.e. 
entities specialized in the provision of the services of water and sanitation (regardless of their degree of autonomy in their 
decision making and financial management.

The service providers *"prestadores de los servicios de agua y saneamiento"* in Mexico are extremely heterogeneous in nature and conditions. 

In this project, the classification that we use is mostly derived from a _Nota Tecnica_ prepared by some colleagues of the IADB, WSA division [See @riquelme_organismos_2018, pp. 1-3]. This tracks some key information on **2,252 Prestadores**. 


+ "TIPO" refers to the juridical status of the agency: **654** are considered proper "PRESTADORES", whereas 1,557 are not considered as proper utilities in the classification, respectively:  
	* 1,332 are *No clasificado*
	* 245 are cases in which the municipalities that directly provide water and sanitation services
	
```{r OperTIPO, echo=FALSE, message=FALSE, results = 'asis'}

load( here( "data", "prestadores_Popa_UTF.Rdata"))

# https://cran.r-project.org/web/packages/summarytools/vignettes/Introduction.html
library(summarytools)
Freq_Tipo <- summarytools::freq(prestadores_Popa_UTF$Tipo_lbl , 
			 report.nas = FALSE, 
			round.digits = 2, # default 2
			order = "freq", #  
			 style = 'rmarkdown', #  
			 omit.headings = T
			) 

# # Then use view(), like so:
#  view(Freq_Tipo, method = "pander", style = "rmarkdown", omit.headings = TRUE)
# 
# print(Freq_Tipo, style = "rmarkdown", report.nas = FALSE, 
#                  totals = FALSE, omit.headings = TRUE)
# # print(FreqTipo)
# 
# kable(FreqTipo) %>%
#   kable_styling("striped", full_width = F, latex_options = "scale_down") # %>%
#   #   row_spec(11, bold = T, color = "white", background = "#D7261E")


knitr::kable(Freq_Tipo, 
				 format = "pandoc", 
				 digits = 2, 
				 caption = "Agencies Providing Water & Sanitation by Type (Including when Not properly defined")
```

+ "RANGO" refers to the size of the populaition served.  



```{r OperRANGO, echo=FALSE, message=FALSE, results = 'asis'}

load( here( "data", "prestadores_Popa_UTF.Rdata"))

# https://cran.r-project.org/web/packages/summarytools/vignettes/Introduction.html
library(summarytools)
Freq_Rango <- summarytools::freq(prestadores_Popa_UTF$Rango_lbl , 
			 report.nas = FALSE, 
			round.digits = 2, # default 2
			order = "freq", #  
			 style = 'rmarkdown', #  
			 omit.headings = T
			) 

# # Then use view(), like so:
#  view(Freq_Tipo, method = "pander", style = "rmarkdown", omit.headings = TRUE)
# 
# print(Freq_Tipo, style = "rmarkdown", report.nas = FALSE, 
#                  totals = FALSE, omit.headings = TRUE)
# # print(FreqTipo)
# 
# kable(FreqTipo) %>%
#   kable_styling("striped", full_width = F, latex_options = "scale_down") # %>%
#   #   row_spec(11, bold = T, color = "white", background = "#D7261E")


knitr::kable(Freq_Rango, 
				 format = "pandoc", 
				 digits = 2, 
				 caption = "Agencies Providing Water & Sanitation by size of population served (Including when Not properly defined")
```


## Which Entidades and Municipios

The ENTIDADES and MUNICIPIOS INCLUDING LAPOP/POPA clusters (2016 --> closely followed in 2018)
	--> saved POPA Cluster size by Admin Bound in 
	--> saved SPJOIN RESULTS LAPOP FENCES intersected with Mun (Centroids and fences) 
	 

```{r,  echo=FALSE, fig.cap="The ENTIDADES which include LAPOP clusters by # of hh interviewed in 2016", out.width = '100%', results='asis'}

# knitr::include_graphics(paste0(to_dir,"/01_tmap_PopaSampleE.png"))   # NOT RENDERING 

### #list.files(path = to_dir)
```	
	


## (PHASE II) The households served in the respective service areas of the surveyed Water & Sanitation Providers 

### Spatial identification of hh clusters

First of all, let's see where the household clusters are located. 

![The ENTIDADES which include LAPOP clusters by # of hh interviewed in 2016](./output/01_tmap_PopaSampleE.png) 




```{r,  echo=FALSE, fig.cap="The MUNICIPIOS which include LAPOP clusters by # of hh interviewed in 2016", out.width = '100%', results='asis'}
# knitr::include_graphics(paste0(to_dir,"/01_tmap_PopaSampleM.png")) # NOT RENDERING 

### #list.files(path = to_dir)
```	

![The MUNICIPIOS which include LAPOP clusters by # of hh interviewed in 2016](./output/01_tmap_PopaSampleM.png) 


### Changes occurred between 2000-2010 in areas of interest

Look at Changes in ENTIDADES and MUNICIPIOS covered by LAPOP/POPA clusters according to census 2010 compared to census 2000


......










## REFERENCE



```{r knitAttempt, echo = F, eval=F}
# knitr::knit2html('./sample.Rmd',encoding = 'UTF-8',force_v1 = TRUE)
```

